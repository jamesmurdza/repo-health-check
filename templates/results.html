{% extends "base.html" %}

{% block title %}{{ owner }}/{{ repo }} - Health Dashboard{% endblock %}

{% block content %}
<div class="d-flex align-items-center mb-4">
    <a href="{{ url_for('home') }}" class="btn btn-link text-decoration-none me-3 p-0" title="Back to Home">
        <i class="fas fa-arrow-left fs-4"></i>
    </a>
    <div>
        <h1 class="page-title">
            <i class="fab fa-github me-2 icon-muted"></i>
            <span id="repoName">{{ owner }}/{{ repo }}</span>
        </h1>
        <p class="text-muted subtitle">Repository Health Analysis</p>
    </div>
</div>

<!-- Loading Indicator -->
<div id="loadingIndicator" class="text-center py-5">
    <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <h4>Analyzing Repository Health...</h4>
    <p class="text-muted">This may take a few moments while we gather data from the GitHub API</p>
</div>

<!-- Results Container -->
<div id="resultsContainer" style="display: none;">
    <!-- Responsiveness Section -->
    <section class="mb-4 mt-4">
        <h2 class="section-title">
            <i class="fas fa-clock me-2" style="color: black;"></i>Responsiveness
        </h2>
        <div class="row g-3" id="responsivenessMetrics">
            <!-- Metrics will be populated here -->
        </div>
    </section>

    <!-- Activity Section -->
    <section class="mb-4">
        <h2 class="section-title">
            <i class="fas fa-chart-bar me-2" style="color: black;"></i>Activity
        </h2>
        <div class="row g-3" id="activityMetrics">
            <!-- Metrics will be populated here -->
        </div>
    </section>

    <!-- Community Section -->
    <section class="mb-4">
        <h2 class="section-title">
            <i class="fas fa-users me-2" style="color: black;"></i>Community
        </h2>
        <div class="row g-3" id="communityMetrics">
            <!-- Metrics will be populated here -->
        </div>
    </section>
</div>

<!-- Error Container -->
<div id="errorContainer" style="display: none;" class="alert alert-danger">
    <h4 class="alert-heading">
        <i class="fas fa-exclamation-triangle me-2"></i>Analysis Failed
    </h4>
    <p id="errorMessage"></p>
    <hr>
    <p class="mb-0">
        <a href="{{ url_for('home') }}" class="btn btn-outline-danger">Try Another Repository</a>
    </p>
</div>

<!-- Metric Detail Modals -->
<div class="modal fade" id="metricModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Modal content will be populated here -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
const owner = {{ owner|tojson }};
const repo = {{ repo|tojson }};

// Load metrics on page load
document.addEventListener('DOMContentLoaded', function() {
    loadMetrics();
});

async function loadMetrics() {
    try {
        const response = await fetch(`/api/analyze/${owner}/${repo}`);
        const data = await response.json();
        
        if (response.ok) {
            displayMetrics(data);
            document.getElementById('loadingIndicator').style.display = 'none';
            document.getElementById('resultsContainer').style.display = 'block';
        } else {
            throw new Error(data.error || 'Failed to analyze repository');
        }
    } catch (error) {
        console.error('Error loading metrics:', error);
        document.getElementById('loadingIndicator').style.display = 'none';
        document.getElementById('errorContainer').style.display = 'block';
        document.getElementById('errorMessage').textContent = error.message;
    }
}

function displayMetrics(data) {
    // Display responsiveness metrics
    displayResponsivenessMetrics(data.responsiveness);
    
    // Display activity metrics
    displayActivityMetrics(data.activity);
    
    // Display community metrics
    displayCommunityMetrics(data.community);
}

function displayResponsivenessMetrics(metrics) {
    const container = document.getElementById('responsivenessMetrics');
    
    const metricCards = [
        {
            title: 'Median Issue Close Time',
            value: `${Math.round(metrics.median_issue_close_time)} days`,
            icon: 'fas fa-bug',
            classification: getTimeClassification(metrics.median_issue_close_time),
            modalId: 'issueCloseTime',
            modalData: metrics.issue_close_times_distribution
        },
        {
            title: 'Median PR Merge Time',
            value: `${Math.round(metrics.median_pr_merge_time)} days`,
            icon: 'fas fa-code-branch',
            classification: getTimeClassification(metrics.median_pr_merge_time),
            modalId: 'prMergeTime',
            modalData: metrics.pr_merge_times_distribution
        },
        {
            title: 'Stale Issues',
            value: metrics.stale_issues.toString(),
            icon: 'fas fa-exclamation-circle',
            classification: getStaleClassification(metrics.stale_issues),
            modalId: 'staleIssues',
            modalData: { count: metrics.stale_issues }
        },
        {
            title: 'Stale PRs',
            value: metrics.stale_prs.toString(),
            icon: 'fas fa-clock',
            classification: getStaleClassification(metrics.stale_prs),
            modalId: 'stalePRs',
            modalData: { count: metrics.stale_prs }
        }
    ];
    
    container.innerHTML = metricCards.map(createMetricCard).join('');
}

function displayActivityMetrics(metrics) {
    const container = document.getElementById('activityMetrics');
    
    const metricCards = [
        {
            title: 'Commits (30 days)',
            value: metrics.commits_last_30_days.toString(),
            icon: 'fas fa-code',
            classification: getCommitsClassification(metrics.commits_last_30_days),
            modalId: 'commits',
            modalData: { count: metrics.commits_last_30_days }
        },
        {
            title: 'Active Contributors',
            value: metrics.active_contributors.toString(),
            icon: 'fas fa-user-friends',
            classification: getContributorsClassification(metrics.active_contributors),
            modalId: 'contributors',
            modalData: metrics.top_contributors
        },
        {
            title: 'Issue Close Rate',
            value: `${metrics.issue_close_rate}%`,
            icon: 'fas fa-check-circle',
            classification: getRateClassification(metrics.issue_close_rate),
            modalId: 'issueRate',
            modalData: { rate: metrics.issue_close_rate }
        },
        {
            title: 'PR Merge Rate',
            value: `${metrics.pr_merge_rate}%`,
            icon: 'fas fa-check-double',
            classification: getRateClassification(metrics.pr_merge_rate),
            modalId: 'prRate',
            modalData: { rate: metrics.pr_merge_rate }
        }
    ];
    
    container.innerHTML = metricCards.map(createMetricCard).join('');
}

function displayCommunityMetrics(metrics) {
    const container = document.getElementById('communityMetrics');
    
    const metricCards = [
        {
            title: 'GitHub Health Score',
            value: `${metrics.health_score}%`,
            icon: 'fas fa-heart',
            classification: getRateClassification(metrics.health_score),
            modalId: 'healthScore',
            modalData: metrics.health_files
        },
        {
            title: 'New Contributors',
            value: metrics.new_contributors.toString(),
            icon: 'fas fa-user-plus',
            classification: getContributorsClassification(metrics.new_contributors),
            modalId: 'newContributors',
            modalData: { count: metrics.new_contributors }
        },
        {
            title: 'Good First Issues',
            value: metrics.good_first_issues.toString(),
            icon: 'fas fa-seedling',
            classification: getFirstIssuesClassification(metrics.good_first_issues),
            modalId: 'firstIssues',
            modalData: { count: metrics.good_first_issues }
        },
        {
            title: 'External Contributions',
            value: `${metrics.external_contribution_pct}%`,
            icon: 'fas fa-external-link-alt',
            classification: getRateClassification(metrics.external_contribution_pct),
            modalId: 'externalContrib',
            modalData: { rate: metrics.external_contribution_pct }
        }
    ];
    
    container.innerHTML = metricCards.map(createMetricCard).join('');
}

// Global storage for modal data to avoid XSS
window.modalDataStore = {};

function createMetricCard(metric) {
    // Store modal data safely
    const dataId = `${metric.modalId}_${Date.now()}`;
    window.modalDataStore[dataId] = metric.modalData;
    
    return `
        <div class="col-lg-3 col-md-4 col-sm-6">
            <div class="metric-card ${metric.classification}" onclick="showModal('${metric.modalId}', '${metric.title}', '${dataId}')">
                <div class="d-flex align-items-center">
                    <div class="metric-icon me-3">
                        <i class="${metric.icon}"></i>
                    </div>
                    <div class="metric-content flex-grow-1">
                        <h6 class="metric-title mb-1">${metric.title}</h6>
                        <div class="metric-value">${metric.value}</div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Classification functions
function getTimeClassification(days) {
    if (days <= 3) return 'good';
    if (days <= 7) return 'warning';
    return 'danger';
}

function getStaleClassification(count) {
    if (count <= 5) return 'good';
    if (count <= 15) return 'warning';
    return 'danger';
}

function getCommitsClassification(count) {
    if (count >= 20) return 'good';
    if (count >= 5) return 'warning';
    return 'danger';
}

function getContributorsClassification(count) {
    if (count >= 5) return 'good';
    if (count >= 2) return 'warning';
    return 'danger';
}

function getRateClassification(rate) {
    if (rate >= 80) return 'good';
    if (rate >= 60) return 'warning';
    return 'danger';
}

function getFirstIssuesClassification(count) {
    if (count >= 5) return 'good';
    if (count >= 1) return 'warning';
    return 'danger';
}

function showModal(modalId, title, dataId) {
    document.getElementById('modalTitle').textContent = title;
    
    // Get data from safe storage
    const data = window.modalDataStore[dataId];
    if (!data) {
        console.error('Modal data not found for ID:', dataId);
        return;
    }
    
    let modalContent = '';
    
    switch (modalId) {
        case 'issueCloseTime':
        case 'prMergeTime':
            modalContent = createHistogramModal(data, modalId.includes('issue') ? 'Issue Close Times' : 'PR Merge Times');
            break;
        case 'contributors':
            modalContent = createContributorsModal(data);
            break;
        case 'healthScore':
            modalContent = createHealthFilesModal(data);
            break;
        default:
            modalContent = createSimpleModal(data, modalId);
    }
    
    document.getElementById('modalBody').innerHTML = modalContent;
    new bootstrap.Modal(document.getElementById('metricModal')).show();
    
    // Initialize charts for specific modals
    if (modalId === 'issueCloseTime' || modalId === 'prMergeTime') {
        setTimeout(() => createHistogramChart(data, modalId), 100);
    } else if (modalId === 'contributors') {
        setTimeout(() => createContributorsChart(data), 100);
    }
}

function createHistogramModal(data, title) {
    const description = title.includes('Issue') 
        ? 'Shows how quickly issues are being resolved. Lower times indicate better responsiveness to community reports and requests.'
        : 'Shows how quickly pull requests are being merged. Lower times indicate active maintainer engagement and efficient code review processes.';
    
    return `
        <div class="mb-3">
            <p><strong>About this metric:</strong></p>
            <p class="text-muted">${description}</p>
        </div>
        <div style="height: 300px;">
            <canvas id="histogramChart"></canvas>
        </div>
        <div class="mt-3">
            <small class="text-muted">Based on the most recent 100 closed items</small>
        </div>
    `;
}

function createContributorsModal(data) {
    if (!Array.isArray(data) || data.length === 0) {
        return '<p>No contributor data available.</p>';
    }
    
    const description = 'Shows the most active contributors in the last 30 days. A diverse contributor base indicates a healthy, collaborative project that attracts ongoing community involvement.';
    
    return `
        <div class="mb-3">
            <p><strong>About this metric:</strong></p>
            <p class="text-muted">${description}</p>
        </div>
        <div style="height: 300px;">
            <canvas id="contributorsChart"></canvas>
        </div>
    `;
}

function createHealthFilesModal(data) {
    if (!Array.isArray(data) || data.length === 0) {
        return '<p>No health file information available.</p>';
    }
    
    const description = 'GitHub evaluates repositories based on the presence of community health files. These files help new contributors understand how to participate in the project.';
    
    const table = data.map(file => `
        <tr>
            <td>
                <i class="fas fa-${file.present ? 'check text-success' : 'times text-danger'} me-2"></i>
                ${file.name}
            </td>
            <td>
                <span class="badge ${file.present ? 'bg-success' : 'bg-danger'}">
                    ${file.present ? 'Present' : 'Missing'}
                </span>
            </td>
        </tr>
    `).join('');
    
    return `
        <div class="mb-3">
            <p><strong>About this metric:</strong></p>
            <p class="text-muted">${description}</p>
        </div>
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>File</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    ${table}
                </tbody>
            </table>
        </div>
    `;
}

function createSimpleModal(data, modalId) {
    // Create a readable table from the data with descriptions
    let description = '';
    let content = '';
    
    // Add specific descriptions based on modal type
    switch (modalId) {
        case 'staleIssues':
            description = 'Issues that have been open for more than 30 days without activity. High numbers may indicate maintenance challenges or lack of active community engagement.';
            break;
        case 'stalePRs':
            description = 'Pull requests that have been open for more than 30 days without activity. This can signal review bottlenecks or unclear contribution guidelines.';
            break;
        case 'commits':
            description = 'Total number of commits in the last 30 days. Higher activity indicates ongoing development and maintenance.';
            break;
        case 'issueRate':
            description = 'Percentage of issues that get closed over time. Higher rates indicate effective issue management and resolution.';
            break;
        case 'prRate':
            description = 'Percentage of pull requests that get merged over time. Higher rates suggest efficient code review processes.';
            break;
        case 'newContributors':
            description = 'Number of first-time contributors in the last 30 days. Higher numbers indicate a welcoming community that attracts new developers.';
            break;
        case 'firstIssues':
            description = 'Issues labeled as "good first issue" or similar beginner-friendly tags. These help onboard new contributors to the project.';
            break;
        case 'externalContrib':
            description = 'Percentage of contributions from external (non-organization) contributors. Higher percentages indicate strong community involvement beyond core maintainers.';
            break;
        default:
            description = 'Additional details for this metric.';
    }
    
    if (typeof data === 'object' && data !== null) {
        if (data.count !== undefined) {
            content = `<p class="text-center fs-4">${data.count} items</p>`;
        } else if (data.rate !== undefined) {
            content = `<p class="text-center fs-4">${data.rate}%</p>`;
        } else {
            // Convert object to readable table
            const rows = Object.entries(data).map(([key, value]) => `
                <tr>
                    <td class="fw-bold">${key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</td>
                    <td>${value}</td>
                </tr>
            `).join('');
            
            content = `
                <div class="table-responsive">
                    <table class="table table-sm">
                        <tbody>
                            ${rows}
                        </tbody>
                    </table>
                </div>
            `;
        }
    } else {
        content = `<p class="text-center">${data}</p>`;
    }
    
    return `
        <div class="mb-3">
            <p><strong>About this metric:</strong></p>
            <p class="text-muted">${description}</p>
        </div>
        ${content}
    `;
}

function createHistogramChart(data, chartId) {
    const ctx = document.getElementById('histogramChart').getContext('2d');
    
    // Define canonical order for time bins (shortest to longest)
    const BIN_ORDER = ['<1d', '1-2d', '2-7d', '1-2w', '2-4w', '1-3m', '>3m'];
    
    // Convert data to array of {label, count} objects
    const dataItems = Object.entries(data).map(([label, count]) => ({
        label: label.trim(),
        count: count
    }));
    
    // Sort by canonical order
    const sortedItems = dataItems.sort((a, b) => {
        const aIndex = BIN_ORDER.indexOf(a.label);
        const bIndex = BIN_ORDER.indexOf(b.label);
        return aIndex - bIndex;
    });
    
    // Extract sorted labels and values from the same sorted array
    const sortedLabels = sortedItems.map(item => item.label);
    const sortedValues = sortedItems.map(item => item.count);
    
    // Create color mapping based on position (left=green, middle=yellow, right=red)
    const numBars = sortedLabels.length;
    const backgroundColor = sortedLabels.map((_, index) => {
        if (numBars <= 2) {
            // For 1-2 bars, use good and danger
            return index === 0 ? 'rgba(40, 167, 69, 0.8)' : 'rgba(220, 53, 69, 0.8)';
        } else if (numBars === 3) {
            // For 3 bars: good, warning, danger
            const colors = ['rgba(40, 167, 69, 0.8)', 'rgba(255, 193, 7, 0.8)', 'rgba(220, 53, 69, 0.8)'];
            return colors[index];
        } else {
            // For more bars, distribute colors
            const third = Math.floor(numBars / 3);
            if (index < third) {
                return 'rgba(40, 167, 69, 0.8)'; // good
            } else if (index < third * 2) {
                return 'rgba(255, 193, 7, 0.8)'; // warning
            } else {
                return 'rgba(220, 53, 69, 0.8)'; // danger
            }
        }
    });
    
    const borderColor = backgroundColor.map(color => color.replace('0.8', '1'));
    
    // Destroy existing chart if it exists
    if (window.histogramChart) {
        window.histogramChart.destroy();
    }
    
    window.histogramChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: sortedLabels,
            datasets: [{
                data: sortedValues,
                backgroundColor: backgroundColor,
                borderColor: borderColor,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Count'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Time Range'
                    }
                }
            }
        }
    });
}


function createContributorsChart(data) {
    const ctx = document.getElementById('contributorsChart').getContext('2d');
    
    // Ensure data is an array and has valid structure
    if (!Array.isArray(data) || data.length === 0) {
        console.warn('Invalid contributors data:', data);
        data = []; // fallback to empty array
    }
    
    // Add "Other" category if there are more than 8 contributors
    let chartData = [...data];
    let labels = [];
    let contributions = [];
    
    if (chartData.length > 8) {
        // Show top 7 contributors + "Other"
        const topContributors = chartData.slice(0, 7);
        const otherContributors = chartData.slice(7);
        const otherTotal = otherContributors.reduce((sum, c) => sum + (c.contributions || 0), 0);
        
        labels = [...topContributors.map(c => c.username || 'Unknown'), 'Others'];
        contributions = [...topContributors.map(c => c.contributions || 0), otherTotal];
    } else {
        labels = chartData.map(c => c.username || 'Unknown');
        contributions = chartData.map(c => c.contributions || 0);
    }
    
    // Color coding: main contributors in blue, "Others" in gray
    const backgroundColor = contributions.map((_, index) => {
        if (labels[index] === 'Others') {
            return 'rgba(108, 117, 125, 0.8)'; // gray for others
        }
        return 'rgba(75, 192, 192, 0.8)'; // blue for individuals
    });
    
    const borderColor = backgroundColor.map(color => color.replace('0.8', '1'));
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                data: contributions,
                backgroundColor: backgroundColor,
                borderColor: borderColor,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: false,
            indexAxis: 'y',
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Contributions'
                    }
                }
            }
        }
    });
}
</script>
{% endblock %}